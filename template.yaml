AWSTemplateFormatVersion: '2010-09-09'
Description: 'Final Stage 1: Foundation with corrected KMS Policy.'

Resources:
  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'Customer Managed Key for the text processing project'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          # Rule 1: Gives your main account full control
          - Sid: 'AllowRootUserToAdministerKey'
            Effect: 'Allow'
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          # Rule 2 (FIX): Gives your pipeline's role full control
          - Sid: 'AllowPipelineRoleToManageKey'
            Effect: 'Allow'
            Principal:
              AWS: "arn:aws:iam::242198490044:role/CodePipelineStarterTemplate-Depl-CloudFormationRole-LMdrMLO8ig1I" # <-- REPLACE THIS VALUE
            Action: "kms:*"
            Resource: "*"

  FileMetadataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: 'file-metadata-table'
      AttributeDefinitions:
        - AttributeName: 'fileId'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'fileId'
          KeyType: 'HASH'
      BillingMode: 'PAY_PER_REQUEST'
      SSESpecification:
        SSEEnabled: true
        KMSMasterKeyId: !Ref KMSKey

  ProcessingNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: 'processing-notifications'
      KmsMasterKeyId: !Ref KMSKey

  FailedExecutionsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: 'processing-dlq'
      KmsMasterKeyId: !Ref KMSKey